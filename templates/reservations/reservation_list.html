{% extends 'base.html' %}
{% load i18n %}

{% block breadcrumbs %}
  <li class="breadcrumb-item active" aria-current="page">
    {% trans "Reservations" %}
  </li>
{% endblock breadcrumbs %}

{% block content %}
  <div class="card-header">
    <i class="bi bi-calendar-check"></i>
    {% translate "Reservations" %}
  </div>
  <div class="card-body">
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
      <a href="{% url 'reservation_creation' %}" class="btn btn-primary">
        {% translate "New reservation" %}
        <i class="bi bi-plus-circle"></i>
      </a>
    </div>
    <div id="calendar"></div>

    {% include 'reservations/includes/reservation_table.html' %}
  </div>
{% endblock %}

{% block javascript %}
  <script>

    async function getResources() {
      try {
        let response = await axios.get('/api/resource')
        let results = response.data.results
        return results
      } catch (err) {
        console.error(err)
      }
    }

    async function getReservations() {
      try {
        let response = await axios.get('/api/reservation')
        let results = response.data.results
        return results
      } catch (err) {
        console.error(err)
      }
    }

    document.addEventListener('DOMContentLoaded', async function() {
      let resources = await getResources()
      let reservations = await getReservations()

      resources.map((resource, idx) => {
        resource.id = resource.pk
        resource.title = resource.label
      })

      reservations.map((reservation, idx) => {
        reservation.id = idx
        reservation.start = reservation.start_date
        reservation.end = reservation.end_date
      })

      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridTwoDay',
        timeZone: 'UTC',
        headerToolbar: {
          left: 'prev,next',
          center: 'title',
          right: 'resourceTimeGridDay,resourceTimeGridTwoDay'
        },
        views: {
          resourceTimeGridTwoDay: {
            type: 'resourceTimeGrid',
            duration: { days: 2 },
            buttonText: '2 days'
          }
        },
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        initialView: 'resourceTimeGridDay',
        resources: [...resources],
        events: [...reservations],
        height: 650,
        eventClick: function(info) {
          let reservation_pk = info.event.extendedProps.pk
          url = '{% url "reservation_detail" 888 %}'
          // cheat to get to corresponding url
          document.location.href = url.replace('888', reservation_pk);
        }
      });

      var events = calendar.getEvents();
      events.map(event => {
        event.setResources([event.extendedProps.resource])
      })
      calendar.render();
    });

  </script>
{% endblock %}
